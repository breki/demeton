// Adapted from "Writing a PNG Decoder in F#, Part II" article by Steve Hawley
// http://plinth.org/techtalk/?p=207&

[<RequireQualifiedAccess>]
module Crc

let crcTable = 
    [|
        0x00000000u ; 0x04C11DB7u ; 0x09823B6Eu ; 0x0D4326D9u ; 0x130476DCu ; 0x17C56B6Bu ; 0x1A864DB2u ; 0x1E475005u ; 
        0x2608EDB8u ; 0x22C9F00Fu ; 0x2F8AD6D6u ; 0x2B4BCB61u ; 0x350C9B64u ; 0x31CD86D3u ; 0x3C8EA00Au ; 0x384FBDBDu ; 
        0x4C11DB70u ; 0x48D0C6C7u ; 0x4593E01Eu ; 0x4152FDA9u ; 0x5F15ADACu ; 0x5BD4B01Bu ; 0x569796C2u ; 0x52568B75u ; 
        0x6A1936C8u ; 0x6ED82B7Fu ; 0x639B0DA6u ; 0x675A1011u ; 0x791D4014u ; 0x7DDC5DA3u ; 0x709F7B7Au ; 0x745E66CDu ; 
        0x9823B6E0u ; 0x9CE2AB57u ; 0x91A18D8Eu ; 0x95609039u ; 0x8B27C03Cu ; 0x8FE6DD8Bu ; 0x82A5FB52u ; 0x8664E6E5u ; 
        0xBE2B5B58u ; 0xBAEA46EFu ; 0xB7A96036u ; 0xB3687D81u ; 0xAD2F2D84u ; 0xA9EE3033u ; 0xA4AD16EAu ; 0xA06C0B5Du ; 
        0xD4326D90u ; 0xD0F37027u ; 0xDDB056FEu ; 0xD9714B49u ; 0xC7361B4Cu ; 0xC3F706FBu ; 0xCEB42022u ; 0xCA753D95u ; 
        0xF23A8028u ; 0xF6FB9D9Fu ; 0xFBB8BB46u ; 0xFF79A6F1u ; 0xE13EF6F4u ; 0xE5FFEB43u ; 0xE8BCCD9Au ; 0xEC7DD02Du ; 
        0x34867077u ; 0x30476DC0u ; 0x3D044B19u ; 0x39C556AEu ; 0x278206ABu ; 0x23431B1Cu ; 0x2E003DC5u ; 0x2AC12072u ; 
        0x128E9DCFu ; 0x164F8078u ; 0x1B0CA6A1u ; 0x1FCDBB16u ; 0x018AEB13u ; 0x054BF6A4u ; 0x0808D07Du ; 0x0CC9CDCAu ; 
        0x7897AB07u ; 0x7C56B6B0u ; 0x71159069u ; 0x75D48DDEu ; 0x6B93DDDBu ; 0x6F52C06Cu ; 0x6211E6B5u ; 0x66D0FB02u ; 
        0x5E9F46BFu ; 0x5A5E5B08u ; 0x571D7DD1u ; 0x53DC6066u ; 0x4D9B3063u ; 0x495A2DD4u ; 0x44190B0Du ; 0x40D816BAu ; 
        0xACA5C697u ; 0xA864DB20u ; 0xA527FDF9u ; 0xA1E6E04Eu ; 0xBFA1B04Bu ; 0xBB60ADFCu ; 0xB6238B25u ; 0xB2E29692u ; 
        0x8AAD2B2Fu ; 0x8E6C3698u ; 0x832F1041u ; 0x87EE0DF6u ; 0x99A95DF3u ; 0x9D684044u ; 0x902B669Du ; 0x94EA7B2Au ; 
        0xE0B41DE7u ; 0xE4750050u ; 0xE9362689u ; 0xEDF73B3Eu ; 0xF3B06B3Bu ; 0xF771768Cu ; 0xFA325055u ; 0xFEF34DE2u ; 
        0xC6BCF05Fu ; 0xC27DEDE8u ; 0xCF3ECB31u ; 0xCBFFD686u ; 0xD5B88683u ; 0xD1799B34u ; 0xDC3ABDEDu ; 0xD8FBA05Au ; 
        0x690CE0EEu ; 0x6DCDFD59u ; 0x608EDB80u ; 0x644FC637u ; 0x7A089632u ; 0x7EC98B85u ; 0x738AAD5Cu ; 0x774BB0EBu ; 
        0x4F040D56u ; 0x4BC510E1u ; 0x46863638u ; 0x42472B8Fu ; 0x5C007B8Au ; 0x58C1663Du ; 0x558240E4u ; 0x51435D53u ; 
        0x251D3B9Eu ; 0x21DC2629u ; 0x2C9F00F0u ; 0x285E1D47u ; 0x36194D42u ; 0x32D850F5u ; 0x3F9B762Cu ; 0x3B5A6B9Bu ; 
        0x0315D626u ; 0x07D4CB91u ; 0x0A97ED48u ; 0x0E56F0FFu ; 0x1011A0FAu ; 0x14D0BD4Du ; 0x19939B94u ; 0x1D528623u ; 
        0xF12F560Eu ; 0xF5EE4BB9u ; 0xF8AD6D60u ; 0xFC6C70D7u ; 0xE22B20D2u ; 0xE6EA3D65u ; 0xEBA91BBCu ; 0xEF68060Bu ; 
        0xD727BBB6u ; 0xD3E6A601u ; 0xDEA580D8u ; 0xDA649D6Fu ; 0xC423CD6Au ; 0xC0E2D0DDu ; 0xCDA1F604u ; 0xC960EBB3u ; 
        0xBD3E8D7Eu ; 0xB9FF90C9u ; 0xB4BCB610u ; 0xB07DABA7u ; 0xAE3AFBA2u ; 0xAAFBE615u ; 0xA7B8C0CCu ; 0xA379DD7Bu ; 
        0x9B3660C6u ; 0x9FF77D71u ; 0x92B45BA8u ; 0x9675461Fu ; 0x8832161Au ; 0x8CF30BADu ; 0x81B02D74u ; 0x857130C3u ; 
        0x5D8A9099u ; 0x594B8D2Eu ; 0x5408ABF7u ; 0x50C9B640u ; 0x4E8EE645u ; 0x4A4FFBF2u ; 0x470CDD2Bu ; 0x43CDC09Cu ; 
        0x7B827D21u ; 0x7F436096u ; 0x7200464Fu ; 0x76C15BF8u ; 0x68860BFDu ; 0x6C47164Au ; 0x61043093u ; 0x65C52D24u ; 
        0x119B4BE9u ; 0x155A565Eu ; 0x18197087u ; 0x1CD86D30u ; 0x029F3D35u ; 0x065E2082u ; 0x0B1D065Bu ; 0x0FDC1BECu ; 
        0x3793A651u ; 0x3352BBE6u ; 0x3E119D3Fu ; 0x3AD08088u ; 0x2497D08Du ; 0x2056CD3Au ; 0x2D15EBE3u ; 0x29D4F654u ; 
        0xC5A92679u ; 0xC1683BCEu ; 0xCC2B1D17u ; 0xC8EA00A0u ; 0xD6AD50A5u ; 0xD26C4D12u ; 0xDF2F6BCBu ; 0xDBEE767Cu ; 
        0xE3A1CBC1u ; 0xE760D676u ; 0xEA23F0AFu ; 0xEEE2ED18u ; 0xF0A5BD1Du ; 0xF464A0AAu ; 0xF9278673u ; 0xFDE69BC4u ; 
        0x89B8FD09u ; 0x8D79E0BEu ; 0x803AC667u ; 0x84FBDBD0u ; 0x9ABC8BD5u ; 0x9E7D9662u ; 0x933EB0BBu ; 0x97FFAD0Cu ;     
        0xAFB010B1u ; 0xAB710D06u ; 0xA6322BDFu ; 0xA2F33668u ; 0xBCB4666Du ; 0xB8757BDAu ; 0xB5365D03u ; 0xB1F740B4u |]

let reversedBytesShift24 = 
    [| 0u; 2147483648u; 1073741824u; 3221225472u; 536870912u; 2684354560u; 1610612736u; 3758096384u; 268435456u; 2415919104u; 1342177280u; 3489660928u; 805306368u; 2952790016u; 1879048192u; 4026531840u; 134217728u; 2281701376u; 1207959552u; 3355443200u; 671088640u; 2818572288u; 1744830464u; 3892314112u; 402653184u; 2550136832u; 1476395008u; 3623878656u; 939524096u; 3087007744u; 2013265920u; 4160749568u; 67108864u; 2214592512u; 1140850688u; 3288334336u; 603979776u; 2751463424u; 1677721600u; 3825205248u; 335544320u; 2483027968u; 1409286144u; 3556769792u; 872415232u; 3019898880u; 1946157056u; 4093640704u; 201326592u; 2348810240u; 1275068416u; 3422552064u; 738197504u; 2885681152u; 1811939328u; 3959422976u; 469762048u; 2617245696u; 1543503872u; 3690987520u; 1006632960u; 3154116608u; 2080374784u; 4227858432u; 33554432u; 2181038080u; 1107296256u; 3254779904u; 570425344u; 2717908992u; 1644167168u; 3791650816u; 301989888u; 2449473536u; 1375731712u; 3523215360u; 838860800u; 2986344448u; 1912602624u; 4060086272u; 167772160u; 2315255808u; 1241513984u; 3388997632u; 704643072u; 2852126720u; 1778384896u; 3925868544u; 436207616u; 2583691264u; 1509949440u; 3657433088u; 973078528u; 3120562176u; 2046820352u; 4194304000u; 100663296u; 2248146944u; 1174405120u; 3321888768u; 637534208u; 2785017856u; 1711276032u; 3858759680u; 369098752u; 2516582400u; 1442840576u; 3590324224u; 905969664u; 3053453312u; 1979711488u; 4127195136u; 234881024u; 2382364672u; 1308622848u; 3456106496u; 771751936u; 2919235584u; 1845493760u; 3992977408u; 503316480u; 2650800128u; 1577058304u; 3724541952u; 1040187392u; 3187671040u; 2113929216u; 4261412864u; 16777216u; 2164260864u; 1090519040u; 3238002688u; 553648128u; 2701131776u; 1627389952u; 3774873600u; 285212672u; 2432696320u; 1358954496u; 3506438144u; 822083584u; 2969567232u; 1895825408u; 4043309056u; 150994944u; 2298478592u; 1224736768u; 3372220416u; 687865856u; 2835349504u; 1761607680u; 3909091328u; 419430400u; 2566914048u; 1493172224u; 3640655872u; 956301312u; 3103784960u; 2030043136u; 4177526784u; 83886080u; 2231369728u; 1157627904u; 3305111552u; 620756992u; 2768240640u; 1694498816u; 3841982464u; 352321536u; 2499805184u; 1426063360u; 3573547008u; 889192448u; 3036676096u; 1962934272u; 4110417920u; 218103808u; 2365587456u; 1291845632u; 3439329280u; 754974720u; 2902458368u; 1828716544u; 3976200192u; 486539264u; 2634022912u; 1560281088u; 3707764736u; 1023410176u; 3170893824u; 2097152000u; 4244635648u; 50331648u; 2197815296u; 1124073472u; 3271557120u; 587202560u; 2734686208u; 1660944384u; 3808428032u; 318767104u; 2466250752u; 1392508928u; 3539992576u; 855638016u; 3003121664u; 1929379840u; 4076863488u; 184549376u; 2332033024u; 1258291200u; 3405774848u; 721420288u; 2868903936u; 1795162112u; 3942645760u; 452984832u; 2600468480u; 1526726656u; 3674210304u; 989855744u; 3137339392u; 2063597568u; 4211081216u; 117440512u; 2264924160u; 1191182336u; 3338665984u; 654311424u; 2801795072u; 1728053248u; 3875536896u; 385875968u; 2533359616u; 1459617792u; 3607101440u; 922746880u; 3070230528u; 1996488704u; 4143972352u; 251658240u; 2399141888u; 1325400064u; 3472883712u; 788529152u; 2936012800u; 1862270976u; 4009754624u; 520093696u; 2667577344u; 1593835520u; 3741319168u; 1056964608u; 3204448256u; 2130706432u; 4278190080u |]

let inline bitrev32 (value: uint32): uint32 =
    let mutable valueRemaining = value
    let mutable accumulator = 0u
    for i in 0 .. 31 do
        accumulator <- 
            (accumulator <<< 1) ||| (valueRemaining &&& 1u)
        valueRemaining <- valueRemaining >>> 1
    accumulator

let crc32 (data: byte[]) =
    let calc() =
        let dataLenMinus1 = data.Length - 1

        let mutable acc = 0xFFffFFffu
        for i in 0 .. dataLenMinus1 do
            let input = data.[i]
            let tupni = reversedBytesShift24.[int input]
            let crc1 = acc ^^^ tupni
            let pos = (crc1 >>> 24) &&& 0xffu |> int32
            acc <- (crc1 <<< 8) ^^^ crcTable.[pos]
        acc
    
    0xFFffFFffu ^^^ (calc() |> bitrev32)
